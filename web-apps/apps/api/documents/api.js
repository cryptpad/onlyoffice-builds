(()=>{"use strict";class e{handler;queue;debug;constructor(e){this.handler=void 0,this.queue=[],this.debug=e}setHandler(e){if(this.handler=this.debug?t=>{console.log(this.debug,t),e(t)}:e,this.queue.length>0){for(const e of this.queue)this.handler(e);this.queue=[]}}fire(e){const t=structuredClone(e);this.handler?setTimeout((()=>this.handler(t))):this.queue.push(t)}}function t(e,n){const o=e,i=n;if("object"!=typeof o)return i;const s=Object.assign({},o);for(const e of Object.keys(i))s[e]=t(o[e],i[e]);return s}function n(){}function o(e=!1){const t=[];let n=!1;return{reg:function(o){e&&n?setTimeout(o):t.push(o)},unreg:function(e){-1!==t.indexOf(e)?t.splice(t.indexOf(e),1):console.log("event handler was already unregistered")},fire:function(...o){e&&n||(n=!0,t.forEach((e=>{e(...o)})))}}}let i;const s=async function(){let e,t;for(const n of document.getElementsByTagName("script"))if(n.src.endsWith("web-apps/apps/api/documents/api.js")){e=n.src,t=n;break}const n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",new URL("api-orig.js",e).href);const o=(s=n,"load",new Promise((e=>{s.addEventListener("load",(()=>e()),{once:!0})})));var s;t.after(n),await o;const a=window;i=a.DocsAPI.DocEditor,a.DocsAPI.DocEditor=r}();class r{waitForAppReady;origEditor;fromOOHandler=new e("fromOO");toOOHandler=new e("toOO");placeholderId;server;constructor(e,t){this.placeholderId=e,this.init(t).catch((e=>{console.error(e)}))}async init(e){let o;await s,this.waitForAppReady=new Promise((e=>{o=e})),this.waitForAppReady.then(e?.events?.onAppReady??n).catch(n);const r=t(e,{events:{onAppReady:o}});this.origEditor=new i(this.placeholderId,r);const a=window;a.APP=a.APP??{},a.APP.setToOOHandler=e=>{this.toOOHandler.setHandler(e)},a.APP.sendMessageFromOO=e=>{this.fromOOHandler.fire(e)}}installLegacyChannel(){const e=o(),t=this.getIframe().contentWindow;window.addEventListener("message",(n=>{n.source===t&&e.fire(n)})),function(e,t,n){let i=!1;const s=[],r=o(!0);e.reg((function(n){if(i)return;const o=n.data;if("_READY"===o)return t("_READY"),i=!0,r.fire(),void s.forEach((function(t){e.fire(t)}));s.push(o)}));const a={},c={},d={},u=[],f={},h={query:function(e,n,o,i){const s=Math.random().toString(16).replace("0.","")+Math.random().toString(16).replace("0.",""),a=(i=i||{}).timeout||3e4;let u;a>0&&(u=setTimeout((function(){delete c[s],o("TIMEOUT")}),a)),d[s]=function(e){clearTimeout(u),delete d[s],e&&(delete c[s],o("UNHANDLED"))},c[s]=function(e,t){delete c[s],o(void 0,e.content,t)},r.reg((function(){const o={txid:s,content:n,q:e,raw:i.raw};t(i.raw?o:JSON.stringify(o))}))}},l=h.event=function(e,n,o){o=o||{},r.reg((function(){const i={content:n,q:e,raw:o.raw};t(o.raw?i:JSON.stringify(i))}))};h.on=function(e,n,o){const i=function(e,o,i){n(e.content,(function(n){const o={txid:e.txid,content:n};t(i?o:JSON.stringify(o))}),o)};return(a[e]=a[e]||[]).push(i),o||l("EV_REGISTER_HANDLER",e),{stop:function(){const t=a[e].indexOf(i);-1!==t&&a[e].splice(t,1)}}},h.whenReg=function(e,t,n){let o=n;u.indexOf(e)>-1?t():o=!0,o&&(f[e]=f[e]||[]).push(t)},h.onReg=function(e,t){h.whenReg(e,t,!0)},h.on("EV_REGISTER_HANDLER",(function(e){f[e]&&(f[e].forEach((function(e){e()})),delete f[e]),u.push(e)}));let p=!1;h.onReady=function(e){p?e():"function"==typeof e&&h.on("EV_RPC_READY",(function(){p=!0,e()}))},h.ready=function(){h.whenReg("EV_RPC_READY",(function(){h.event("EV_RPC_READY")}))},e.reg((function(e){if(!i)return;if(!e.data||"_READY"===e.data)return;let n;try{n="object"==typeof e.data?e.data:JSON.parse(e.data)}catch(e){return void console.warn(e)}void 0!==n.ack?d[n.txid]&&d[n.txid](!n.ack):"string"==typeof n.q?a[n.q]?(n.txid&&t(JSON.stringify({txid:n.txid,ack:!0})),a[n.q].forEach((function(t){t(n||JSON.parse(e.data),e,n&&n.raw),n=void 0}))):n.txid&&t(JSON.stringify({txid:n.txid,ack:!1})):void 0===n.q&&c[n.txid]&&c[n.txid](n,e)})),t("_READY"),n(h)}(e,(e=>{t.postMessage(e)}),(e=>{this.toOOHandler.setHandler((t=>{e.event("CMD",t)})),e.on("CMD",(e=>{this.fromOOHandler.fire(e)}))}))}destroyEditor(){this.origEditor.destroyEditor()}getIframe(){return document.querySelector('iframe[name="frameEditor"]')}injectCSS(e){const t=this.getIframe().contentDocument.querySelector("head"),n=document.createElement("style");n.innerText=e,t.appendChild(n)}sendMessageToOO(e){this.toOOHandler.fire(e)}connectMockServer(e){this.server=e,this.fromOOHandler.setHandler((e=>{"auth"==e.type?this.handleAuth(e):this.server.onMessage(e)}))}handleAuth(e){console.log("XXX TODO auth");const t=this.server.getParticipants();this.sendMessageToOO({type:"auth",result:1,sessionId:"session-id",participants:t.list,locks:[],changes:[],changesIndex:0,indexUser:t.index,buildVersion:"5.2.6",buildNumber:2,licenseType:3}),this.sendMessageToOO({type:"documentOpen",data:{type:"open",status:"ok",data:{"Editor.bin":e.openCmd.url}}}),this.server?.onAuth()}}})();